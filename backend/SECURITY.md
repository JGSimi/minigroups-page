# üîí Documenta√ß√£o de Seguran√ßa - Mini Groups API

## Vis√£o Geral

Esta API implementa m√∫ltiplas camadas de seguran√ßa para proteger contra ataques comuns e garantir a integridade dos dados.

## üìã √çndice

- [Recursos de Seguran√ßa](#recursos-de-seguran√ßa)
- [Configura√ß√£o no Vercel](#configura√ß√£o-no-vercel)
- [Prote√ß√µes Implementadas](#prote√ß√µes-implementadas)
- [Rate Limiting](#rate-limiting)
- [CORS Policy](#cors-policy)
- [Melhores Pr√°ticas](#melhores-pr√°ticas)
- [Monitoramento](#monitoramento)
- [Reportar Vulnerabilidades](#reportar-vulnerabilidades)

---

## üõ°Ô∏è Recursos de Seguran√ßa

### 1. Headers de Seguran√ßa (Helmet)

A API usa **Helmet** para adicionar headers HTTP de seguran√ßa:

- **Content-Security-Policy**: Previne XSS definindo fontes confi√°veis
- **X-Frame-Options**: DENY - Previne clickjacking
- **Strict-Transport-Security**: For√ßa HTTPS (HSTS)
- **X-Content-Type-Options**: nosniff - Previne MIME sniffing
- **X-XSS-Protection**: Prote√ß√£o XSS para navegadores antigos
- **Referrer-Policy**: Controla informa√ß√µes de refer√™ncia
- **Permissions-Policy**: Restringe APIs de recursos sens√≠veis

### 2. Rate Limiting

Prote√ß√£o contra ataques DDoS e abuso:

#### Rate Limit Geral
```
100 requisi√ß√µes por 15 minutos por IP
```

#### Rate Limit da API
```
60 requisi√ß√µes por 15 minutos por IP para /api/*
```

#### Rate Limit Estrito (se necess√°rio)
```
10 requisi√ß√µes por minuto
```

**Headers retornados:**
- `RateLimit-Limit`: N√∫mero m√°ximo de requisi√ß√µes
- `RateLimit-Remaining`: Requisi√ß√µes restantes
- `RateLimit-Reset`: Timestamp de reset do limite

### 3. CORS (Cross-Origin Resource Sharing)

Pol√≠tica restritiva de CORS:

**Origens Permitidas em Produ√ß√£o:**
- `https://minigroups.vercel.app`
- Vari√°vel de ambiente `FRONTEND_URL`

**Origens Permitidas em Desenvolvimento:**
- `localhost:*` (todas as portas)

**Configura√ß√µes:**
- Credentials: Permitido
- M√©todos: GET, POST, PUT, DELETE, OPTIONS, PATCH
- Headers permitidos: Content-Type, Authorization, X-API-Key

### 4. Valida√ß√£o e Sanitiza√ß√£o de Input

Todas as entradas s√£o validadas e sanitizadas:

- **express-validator**: Valida√ß√£o de par√¢metros
- **Sanitiza√ß√£o autom√°tica**: Remove caracteres perigosos
- **Detec√ß√£o de padr√µes de ataque**: SQL Injection, XSS, Path Traversal

**Padr√µes detectados:**
- SQL Injection: `', --, #, union, select, drop`
- XSS: `<script>`, event handlers, `javascript:`
- Path Traversal: `../`, `..%2F`
- Command Injection: `exec, eval, system`

### 5. Limites de Payload

Prote√ß√£o contra payloads maliciosos grandes:

- **Tamanho m√°ximo**: 100KB
- **Content-Type validado**: Apenas `application/json`
- **Timeout de requisi√ß√£o**: 30 segundos

### 6. Logging Seguro

Sistema de logging que n√£o exp√µe informa√ß√µes sens√≠veis:

**Em Produ√ß√£o:**
- Logs estruturados em JSON
- N√£o exibe stack traces
- Reda√ß√£o autom√°tica de dados sens√≠veis (passwords, tokens, API keys)
- Apenas erros e requisi√ß√µes lentas s√£o logadas

**Em Desenvolvimento:**
- Logs detalhados e coloridos
- Stack traces completos
- Todas as requisi√ß√µes s√£o logadas

### 7. Prote√ß√£o contra Ataques Comuns

- **SQL Injection**: Valida√ß√£o de inputs, sanitiza√ß√£o
- **XSS (Cross-Site Scripting)**: CSP, sanitiza√ß√£o de HTML
- **CSRF**: SameSite cookies (quando implementado)
- **Clickjacking**: X-Frame-Options DENY
- **MIME Sniffing**: X-Content-Type-Options nosniff
- **Command Injection**: Detec√ß√£o de padr√µes
- **Path Traversal**: Valida√ß√£o de caminhos

---

## ‚öôÔ∏è Configura√ß√£o no Vercel

### 1. Deploy Inicial

```bash
cd backend
npm run build
vercel --prod
```

### 2. Configurar Vari√°veis de Ambiente

No dashboard do Vercel:
1. V√° em **Settings** > **Environment Variables**
2. Adicione as seguintes vari√°veis:

```env
NODE_ENV=production
FRONTEND_URL=https://minigroups.vercel.app
# API_KEY=gere_uma_chave_secreta_aqui (opcional)
```

**Para gerar API_KEY segura:**
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 3. Configura√ß√µes Recomendadas no Vercel

- **Region**: `gru1` (S√£o Paulo) - J√° configurado
- **Memory**: 1024 MB - J√° configurado
- **Max Duration**: 30s - J√° configurado
- **Node Version**: 20.x (recomendado)

### 4. Dom√≠nio Customizado (Opcional)

Se usar dom√≠nio pr√≥prio:
1. Configure o dom√≠nio no Vercel
2. Adicione o dom√≠nio em `FRONTEND_URL`
3. Atualize `/backend/src/config/cors.ts`

---

## üîç Prote√ß√µes Implementadas

### Middleware Stack (Ordem de Execu√ß√£o)

```
1. Helmet          ‚Üí Headers de seguran√ßa
2. CORS            ‚Üí Valida√ß√£o de origem
3. Rate Limiting   ‚Üí Prote√ß√£o contra abuso
4. Payload Limit   ‚Üí Limite de tamanho
5. JSON Parser     ‚Üí Parse de body
6. Request Timeout ‚Üí Timeout de 30s
7. Sanitize Headers‚Üí Limpa headers sens√≠veis
8. Validate Origin ‚Üí Valida origem em produ√ß√£o
9. Attack Detection‚Üí Detecta padr√µes de ataque
10. Sanitize Input ‚Üí Sanitiza todos os inputs
11. Content-Type   ‚Üí Valida Content-Type
12. Request Logger ‚Üí Loga requisi√ß√µes
```

### Validadores de Rotas

Valida√ß√£o espec√≠fica por endpoint:

```typescript
// Exemplo: GET /api/games/:placeId
validateGameId ‚Üí Valida que placeId √© n√∫mero v√°lido

// Exemplo: GET /api/games?search=valor
validateGameQuery ‚Üí Valida par√¢metros de busca
```

---

## üìä Rate Limiting

### Configura√ß√£o Atual

| Tipo | Limite | Janela | Endpoints |
|------|--------|--------|-----------|
| Geral | 100 req | 15 min | Todos |
| API | 60 req | 15 min | `/api/*` |
| Estrito | 10 req | 1 min | (N√£o ativo) |

### Resposta de Rate Limit Excedido

```json
{
  "success": false,
  "error": "Muitas requisi√ß√µes. Por favor, aguarde antes de tentar novamente.",
  "retryAfter": 900
}
```

### Bypass de Rate Limit (Opcional)

Se configurar `API_KEY`, requisi√ß√µes com header v√°lido ignoram rate limit:

```bash
curl -H "X-API-Key: sua_chave_aqui" https://api.example.com/api/games
```

---

## üåê CORS Policy

### Origens Permitidas

**Produ√ß√£o:**
```javascript
[
  'https://minigroups.vercel.app',
  process.env.FRONTEND_URL
]
```

**Desenvolvimento:**
```javascript
Todas as origens localhost:*
```

### Testar CORS

```bash
curl -H "Origin: https://minigroups.vercel.app" \
     -H "Access-Control-Request-Method: GET" \
     -H "Access-Control-Request-Headers: Content-Type" \
     -X OPTIONS \
     https://minigroups-backend.vercel.app/api/games
```

---

## ‚úÖ Melhores Pr√°ticas

### Para Desenvolvedores

1. **Nunca commite secrets no Git**
   - Use `.env` para secrets locais
   - Configure no Vercel para produ√ß√£o
   - Mantenha `.env.example` atualizado

2. **Valide todos os inputs**
   - Use os validadores em `middleware/validators.ts`
   - Sanitize antes de usar dados
   - Nunca confie em dados do cliente

3. **Mantenha depend√™ncias atualizadas**
   ```bash
   npm audit
   npm update
   ```

4. **Use HTTPS sempre**
   - Vercel fornece HTTPS automaticamente
   - Force HSTS (j√° configurado)

5. **Implemente logging adequado**
   - Use o logger em `utils/logger.ts`
   - N√£o logue dados sens√≠veis
   - Monitore logs de seguran√ßa

### Para Deploy

1. **Antes do deploy:**
   ```bash
   npm run build
   npm run type-check
   ```

2. **Ap√≥s deploy:**
   - Teste todos os endpoints
   - Verifique headers de seguran√ßa
   - Confirme rate limiting funcionando
   - Valide CORS

3. **Monitoramento cont√≠nuo:**
   - Verifique logs do Vercel
   - Monitore tentativas de ataque
   - Atualize configura√ß√µes conforme necess√°rio

---

## üìà Monitoramento

### Logs de Seguran√ßa

Eventos monitorados:

1. **CORS Violations**
   ```
   [SECURITY] CORS violation - origem n√£o permitida
   ```

2. **Rate Limit Exceeded**
   ```
   [SECURITY] Rate limit excedido por IP: xxx.xxx.xxx.xxx
   ```

3. **Padr√µes de Ataque**
   ```
   [SECURITY] Padr√£o de ataque detectado: SQL Injection
   ```

4. **Rotas N√£o Encontradas**
   ```
   [WARN] Rota n√£o encontrada: GET /api/admin
   ```

### Verificar Logs no Vercel

1. Acesse o dashboard do Vercel
2. V√° em **Deployments** > Selecione o deploy
3. Clique em **Functions** > **Logs**
4. Filtre por `[SECURITY]` ou `[ERROR]`

### M√©tricas Importantes

- Taxa de requisi√ß√µes bloqueadas por rate limit
- N√∫mero de viola√ß√µes CORS
- Tentativas de ataque detectadas
- Tempo m√©dio de resposta
- Taxa de erros 5xx

---

## üö® Reportar Vulnerabilidades

Se voc√™ descobrir uma vulnerabilidade de seguran√ßa:

1. **N√ÉO** abra uma issue p√∫blica no GitHub
2. Entre em contato diretamente com a equipe: **[seu-email@exemplo.com]**
3. Inclua:
   - Descri√ß√£o detalhada da vulnerabilidade
   - Passos para reproduzir
   - Impacto potencial
   - Sugest√µes de corre√ß√£o (se houver)

### Pol√≠tica de Divulga√ß√£o Respons√°vel

- Responderemos em at√© 48 horas
- Trabalharemos em uma corre√ß√£o
- Creditaremos o descobridor (se desejado)
- Divulgaremos ap√≥s corre√ß√£o

---

## üîê Checklist de Seguran√ßa

Antes de ir para produ√ß√£o:

- [ ] Todas as vari√°veis de ambiente configuradas no Vercel
- [ ] FRONTEND_URL definida corretamente
- [ ] Testado rate limiting funcionando
- [ ] Validado CORS apenas permite origem correta
- [ ] Verificado headers de seguran√ßa no response
- [ ] Logs n√£o exp√µem informa√ß√µes sens√≠veis
- [ ] Depend√™ncias atualizadas (`npm audit`)
- [ ] Build completo sem erros
- [ ] Testado todos os endpoints principais
- [ ] Documenta√ß√£o atualizada

---

## üìö Recursos Adicionais

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Helmet Documentation](https://helmetjs.github.io/)
- [Express Security Best Practices](https://expressjs.com/en/advanced/best-practice-security.html)
- [Vercel Security](https://vercel.com/docs/security)

---

## üìù Changelog de Seguran√ßa

### v2.0.0 (2025-01-XX)

**Implementado:**
- ‚úÖ Helmet para headers de seguran√ßa
- ‚úÖ Rate limiting em 3 n√≠veis
- ‚úÖ CORS restritivo
- ‚úÖ Valida√ß√£o e sanitiza√ß√£o de inputs
- ‚úÖ Detec√ß√£o de padr√µes de ataque
- ‚úÖ Logging seguro
- ‚úÖ Limites de payload
- ‚úÖ Timeout de requisi√ß√µes
- ‚úÖ Headers de seguran√ßa no Vercel

**Pr√≥ximas melhorias:**
- üîÑ Sistema de API Keys
- üîÑ WAF (Web Application Firewall)
- üîÑ 2FA para endpoints admin (se implementado)
- üîÑ Audit logs
- üîÑ IP Whitelist/Blacklist

---

## üìû Suporte

Para quest√µes de seguran√ßa: **[seu-email@exemplo.com]**

Para quest√µes gerais: Abra uma issue no GitHub

---

**√öltima atualiza√ß√£o:** 2025-01-XX
**Vers√£o:** 2.0.0
**Mantenedor:** Mini Groups Studio
